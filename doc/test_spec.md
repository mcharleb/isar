# ISAR test specifications

This documents describes the features implemented by ISAR, and gives step by step instructions to test them.

## Unique build directory for all targets

* Description: all artifacts should be generated within the same build directory
* Testing:
  ```
      # Initialize the build directory
      $ source isar-init-build-env build
      # Start the build for all targets
      $ bitbake \
          multiconfig:qemuarm:isar-image-base \
          multiconfig:rpi:isar-image-base \
          multiconfig:qemui386:isar-image-base \
          multiconfig:qemuamd64:isar-image-base
  ```

## `qemu` support for all targets

* Description: all artifacts are compatible with `qemu`, which is used to verify that the images are properly generated
* Testing: all architectures come with a `start_*_vm` script (accessible directly from within the build directory), which runs `qemu` with the artifacts generated during the build, e.g.:
  ```
      # Initialize the build directory
      $ source isar-init-build-env build
      # Start the build for the i386 target
      $ bitbake multiconfig:qemui386:isar-image-base
      # Run the artifacts in `qemu`
      $ start_i386_vm
  ```
* Notes: an actual Raspberry Pi 1B is needed to test the image generated by the `multiconfig:rpi:isar-image-base` target, as some proprietary blobs are needed to boot it

## EFI disk image generation using `wic` for intel based architectures

* Description: full disk images can be generated then written on SD card and tested on real hardware directly instead of using `qemu`
* Testing: the `wic` utility can generate an image after the artifacts have be built, as follows:
  ```
      # The artifacts of the target passed here have to have been built previously
      $ wic create -D sdimage-efi -o . -e multiconfig:qemuamd64:isar-image-base
      # Or
      $ wic create -D sdimage-efi -o . -e multiconfig:qemui386:isar-image-base
  ```
* Notes: to verify that the images generated work, use the following command, after compiling EFI firmware:
  ```
      # For 32bits intel architectures
      $ qemu-system-i386 -m 256M -nographic -bios edk2/Build/OvmfX32/RELEASE_*/FV/OVMF_CODE.fd -hda ./sdimage-*
      # For 64bits intel architectures
      $ qemu-system-x86_64 -m 256M -nographic -bios edk2/Build/OvmfX64/RELEASE_*/FV/OVMF_CODE.fd -hda ./sdimage-*
  ```

## Raspberry Pi image disk generation using `wic`

* Description: full disk images can be generated then written on SD card and tested on real hardware directly instead of using `qemu`
* Testing: the `wic` utility can generate the image after the artifacts have be built, as follows:
  ```
      # Initialize the build directory
      $ source isar-init-build-env build
      # Start the build for all targets
      $ bitbake multiconfig:rpi:isar-image-base
      $ wic create -D sdimage-raspberrypi -o . -e multiconfig:rpi:isar-image-base
  ```
* Notes: physical hardware (i.e. a Raspberry Pi 1B) is required to test the image, which should be written on an SD card

## Build speedups through Deb package caching

* Description: when ISAR has generated a Deb package for an "app", this feature stores it into a local repository and reuses it in subsequent builds
* Testing: after building the artifacts for a given target, the `meta-isar-bin/apt` directory will contain repositories named after the target distribution,
           and containing source and binary packages built during the build phase.

## Package cache sharing

* Description: when a developer has built an image and populated his Deb cache with packages, they can share it with other developers
* Testing: once a build has been completed, the `meta-isar-bin/apt` directory can be copied over to another system, and ISAR made to use this copy as a cache
  instead of generating its own from scratch:
  ```
      # Start the build for the i386 target
      $ bitbake multiconfig:qemui386:isar-image-base
      # Copy the cache to another directory/system
      $ cp -r ../meta-isar-bin/apt /path/to/nfs/share/
      
      # Tell ISAR on another system to use the cache
      $ echo DEBCACHEDIR=/path/to/nfs/share/apt >> meta-isar/conf/local.conf.sample
      # Start the build for the i386 target, using the cache
      $ bitbake multiconfig:qemui386:isar-image-base
  ```
